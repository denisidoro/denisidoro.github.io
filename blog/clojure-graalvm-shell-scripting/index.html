<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      :root {
        --accent-color: #05a081;
        --accent-color-light: #82d0c0;
      }
    </style>

    <meta name="theme-color" content="#05a081" />

    
      <link rel="icon" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;bb8e06f1bd83412a00.jpg" />
      <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;bb8e06f1bd83412a00.jpg" />
      <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;919926a10d297a1500.jpg" />
      <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;6c2aa64354c1ad0e00.jpg" />
      <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;f15f82763548a03000.jpg" />
      <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;60ba6917360f159900.jpg" />
      <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;be09d2da8b7096cc00.jpg" />
      <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;165598e81aa1737500.jpg" />
      <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;ca26ad195d4a364c00.jpg" />
    

    

    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary">

    

    

    
      
        <meta name="description" content="About me and blog posts" />
        <meta name="twitter:description" content="About me and blog posts">
      
    

    
      <meta name="twitter:title" content="Using Clojure + GraalVM for shell scripting">
    

    
      <link rel="prerender" href="&#x2F;tags&#x2F;" />
    
      <link rel="prerender" href="&#x2F;blog&#x2F;" />
    

    <link rel="prefetch" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;d8f0e5c553a5794d00.jpg" />

    <title>
      
        
          Using Clojure + GraalVM for shell scripting
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://denisidoro.github.io/main.css">
    
    

<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;tips-for-faster-development&#x2F;">



<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;microservice-splitting-code-refactoring&#x2F;">



<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;dev&#x2F;">

<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;clojure&#x2F;">

<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;shell&#x2F;">


<script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "Using Clojure + GraalVM for shell scripting",
      "image": [],
      "datePublished": "2018-09-14T00:00:00+00:00",
      "dateModified": "2018-09-14T00:00:00+00:00",
      "author": {
        "@type": "Person",
        "name": "Denis Isidoro"
      },
       "publisher": {
        "@type": "Organization",
        "name": "Denis Isidoro",
        "logo": {
          "@type": "ImageObject",
          "url": "https://denisidoro.github.io/profile_square.jpg"
        }
        
      }
      
    }
  </script>

<script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "Denis&#x27;s blog",
          "item": "https://denisidoro.github.io/"
        },
        
        {
          
          "@type": "ListItem",
          "position": 2,
          "name": "",
          "item": "https://denisidoro.github.io/blog/"
        },
        
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Using Clojure + GraalVM for shell scripting",
          "item": "https://denisidoro.github.io/blog/clojure-graalvm-shell-scripting/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;d8f0e5c553a5794d00.jpg" alt="profile picture">
        </a>
        <nav>
          
            <a href="&#x2F;tags&#x2F;">Tags</a>
          
            <a href="&#x2F;blog&#x2F;">Blog</a>
          
        </nav>
      </header>
    
    <main>
    
<div class="post-title">
  <h1>Using Clojure + GraalVM for shell scripting</h1>
  <small>
    September 14, 2018
    
    -
    <span class="tags">
      
      <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;dev&#x2F;">dev</a>
      
      <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;clojure&#x2F;">clojure</a>
      
      <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;shell&#x2F;">shell</a>
      
    </span>
    
  </small>
</div>

<div>
  <figure>
    <img alt="Image for post" class="medium-image"
        src="https://miro.medium.com/max/2160/1*gJm3BZcNrKoPOa2QO69p3Q.png"
        srcSet="https://miro.medium.com/max/552/1*gJm3BZcNrKoPOa2QO69p3Q.png 276w, https://miro.medium.com/max/1104/1*gJm3BZcNrKoPOa2QO69p3Q.png 552w, https://miro.medium.com/max/1280/1*gJm3BZcNrKoPOa2QO69p3Q.png 640w, https://miro.medium.com/max/1400/1*gJm3BZcNrKoPOa2QO69p3Q.png 700w"
        sizes="700px" />
    <figcaption>Part of a shell script written in Clojure</figcaption>
</figure>
<h3 id="motivation">Motivation</h3>
<p>Objective: develop a shell script to ease the writing of XML files.</p>
<p>Let’s say that the output to be generated is:</p>
<pre style="background-color:#f9f9f9;">
<code><span style="color:#5d9be5;">&lt;</span><span style="color:#c82728;">grid</span><span style="color:#5d9be5;">&gt;   
  &lt;</span><span style="color:#c82728;">row</span><span style="color:#5d9be5;">&gt;   
     &lt;</span><span style="color:#c82728;">label id=</span><span style="color:#839c00;">&quot;info&quot; </span><span style="color:#5d9be5;">/&gt;   
     &lt;</span><span style="color:#c82728;">text</span><span style="color:#5d9be5;">&gt;</span><span style="color:#111111;">Now playing</span><span style="color:#5d9be5;">&lt;/</span><span style="color:#c82728;">text</span><span style="color:#5d9be5;">&gt;   
  &lt;/</span><span style="color:#c82728;">row</span><span style="color:#5d9be5;">&gt;   
  &lt;</span><span style="color:#c82728;">row</span><span style="color:#5d9be5;">&gt;   
     &lt;</span><span style="color:#c82728;">button onTap=</span><span style="color:#839c00;">&quot;mute&quot; </span><span style="color:#5d9be5;">/&gt;   
  &lt;/</span><span style="color:#c82728;">row</span><span style="color:#5d9be5;">&gt;   
&lt;/</span><span style="color:#c82728;">grid</span><span style="color:#5d9be5;">&gt;
</span></code></pre>
<p>I’d like to write it as:</p>
<pre style="background-color:#f9f9f9;">
<code><span style="color:#111111;">[:grid [:row [:label {:id :info}]   
             [:text </span><span style="color:#839c00;">&quot;Now playing&quot;</span><span style="color:#111111;">]]   
       [:row [:button :onTap </span><span style="color:#839c00;">&quot;mute&quot;</span><span style="color:#111111;">]]]
</span></code></pre>
<p>By the way, this syntax is a subset of <a href="https://github.com/edn-format/edn">EDN</a> and called <a href="https://github.com/weavejester/hiccup">hiccup</a>, used by frameworks such as <a href="https://github.com/Day8/re-frame">re-frame</a>.</p>
<p>This way, in <a href="https://github.com/denisidoro/dotfiles">my dotfiles</a>, I can store, versionate and compose my configs as hiccup files and not as XML ones.</p>
<p>This is no simple task for Bash and would feel natural to use <a href="https://clojure.org/">Clojure(Script)</a>.</p>
<h3 id="using-clojurescript">Using Clojurescript</h3>
<p>Until some months ago, I would write this script using <a href="https://github.com/anmonteiro/lumo">lumo</a>, a cross-platform, standalone ClojureScript environment.</p>
<p>It runs on Node.js and the V8 JavaScript engine. Also, the scripts are relatively fast: a “hello world” takes ~1s to run without caching on my machine; with caching enabled, ~0.3s.</p>
<p>You can find example scripts and helpers for lumo <a href="https://github.com/denisidoro/dotfiles/tree/ce5cfac70858966687986614443a7e805b60df76/scripts/clojure">here</a>.</p>
<h3 id="using-clojure">Using Clojure</h3>
<p>With the advent of <a href="https://clojure.org/guides/deps_and_cli">Clojure CLI</a> I stopped using lumo and I’m simply using the <code>clj</code> command now.</p>
<p>Migrating from lumo to clj is <a href="https://clojurescript.org/about/differences">trivial</a> and gives us more features, such as better support for macros and multithreading.</p>
<p>I’m using <a href="https://github.com/clojure/tools.deps.alpha">tools.deps</a> for dependency graph expansion and using <a href="https://github.com/RickMoynihan/lein-tools-deps">lein-tools-deps</a> for <a href="https://leiningen.org/">leiningen</a> compatibility.</p>
<p>The downside is the startup time: a simple “hello world” takes around ~2.5s and my XML→hiccup script, which depends on some libraries, needs more than 3s to finish.</p>
<p>This is fine for one-time only scripts but if I call a clj script in a Bash for-loop I’ll probably want to grab some coffee while it runs.</p>
<h3 id="speeding-up-with-graalvm">Speeding up with GraalVM</h3>
<p><a href="https://www.graalvm.org/">GraalVM</a> is a universal virtual machine for running applications written in JavaScript, Ruby, JVM-based languages and more.</p>
<p>By using <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/">AOT compilation</a> we can compile our clj scripts to native code, which doesn’t rely on the JVM. The benefit? Let’s compare startup times:</p>
<pre style="background-color:#f9f9f9;">
<code><span style="color:#c82728;">λ</span><span style="color:#4271ae;"> echo </span><span style="color:#839c00;">&#39;[:table]&#39; </span><span style="color:#3e999f;">| </span><span style="color:#c82728;">time</span><span style="color:#4271ae;"> clj</span><span style="color:#f07219;"> -m</span><span style="color:#4271ae;"> xml 
</span><span style="color:#3e999f;">&lt;</span><span style="color:#111111;">table </span><span style="color:#c82728;">/</span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> 
clj</span><span style="color:#f07219;"> -m</span><span style="color:#4271ae;"> xml 9.88s user 0.68s system 293% cpu 3.593 total 

</span><span style="color:#c82728;">λ</span><span style="color:#4271ae;"> echo </span><span style="color:#839c00;">&#39;[:table]&#39; </span><span style="color:#3e999f;">| </span><span style="color:#c82728;">time</span><span style="color:#4271ae;"> native-binary 
</span><span style="color:#3e999f;">&lt;</span><span style="color:#111111;">table </span><span style="color:#c82728;">/</span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> 
native-binary 0.01s user 0.01s system 79% cpu 0.019 total
</span></code></pre>
<p>That’s 200x faster!</p>
<p>In addition, I can simply copy/paste this binary to any other machine with the same architecture + OS and it will work regardless of JVM or Node.js being installed or not.</p>
<p>Example scripts and helpers for clj and GraalVM can be found <a href="https://github.com/denisidoro/dotfiles/tree/c4f656d6c83f34c106afc61f44568fcd4e3ea1b9/scripts/clojure">here</a>.</p>
<p>For other people’s experiences, click <a href="https://www.innoq.com/en/blog/native-clojure-and-graalvm/">here</a> or <a href="https://www.astrecipes.net/blog/2018/07/20/cmd-line-apps-with-clojure-and-graalvm/">there</a>.</p>
<figcaption>⏮ This post first appeared on
    <a href="https://medium.com/@den.isidoro/https:&#x2F;&#x2F;miro.medium.com&#x2F;max&#x2F;700&#x2F;1*gJm3BZcNrKoPOa2QO69p3Q.png" target="_blank">Medium</a></figcaption>

</div>

<hr class="footer-rule" />


<div class="footer-about">
  <p><em>Note: opinions expressed here are solely my own and do not necessarily express the views or experiences of my employer or past employers.</em></p>

</div>


<div class="related-container">

  
  <div class="link">
    Previous <br />
    <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;tips-for-faster-development&#x2F;">Save 15min a day: tips for faster development</a>
  </div>
  

  
  <div class="link">
    Next <br />
    <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;microservice-splitting-code-refactoring&#x2F;">On microservice splitting and code refactoring</a>
  </div>
  

</div>


    </main>
  </body>
</html>
