<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      :root {
        --accent-color: #05a081;
        --accent-color-light: #82d0c0;
      }
    </style>

    <meta name="theme-color" content="#05a081" />

    
      <link rel="icon" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;bb8e06f1bd83412a00.jpg" />
      <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;bb8e06f1bd83412a00.jpg" />
      <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;919926a10d297a1500.jpg" />
      <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;6c2aa64354c1ad0e00.jpg" />
      <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;f15f82763548a03000.jpg" />
      <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;60ba6917360f159900.jpg" />
      <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;be09d2da8b7096cc00.jpg" />
      <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;165598e81aa1737500.jpg" />
      <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;ca26ad195d4a364c00.jpg" />
    

    

    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary">

    

    

    
      
        <meta name="description" content="About, opinions and rants" />
        <meta name="twitter:description" content="About, opinions and rants">
      
    

    
      <meta name="twitter:title" content="Using Grafana for personal financial management">
    

    
      <link rel="prerender" href="&#x2F;tags&#x2F;" />
    
      <link rel="prerender" href="&#x2F;blog&#x2F;" />
    

    <link rel="prefetch" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;d8f0e5c553a5794d00.jpg" />

    <title>
      
        
          Using Grafana for personal financial management
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://denisidoro.github.io/main.css">
    
    

<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;microservice-splitting-code-refactoring&#x2F;">



<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;monolithic-apps-graph-apis&#x2F;">



<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;grafana&#x2F;">

<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;finance&#x2F;">

<link rel="prerender" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;clojure&#x2F;">


<script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "Using Grafana for personal financial management",
      "image": [],
      "datePublished": "2019-04-04T00:00:00+00:00",
      "dateModified": "2019-04-04T00:00:00+00:00",
      "author": {
        "@type": "Person",
        "name": "Denis Isidoro"
      },
       "publisher": {
        "@type": "Organization",
        "name": "Denis Isidoro",
        "logo": {
          "@type": "ImageObject",
          "url": "https://denisidoro.github.io/profile_square.jpg"
        }
        
      }
      
    }
  </script>

<script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "Denis&#x27;s blog",
          "item": "https://denisidoro.github.io/"
        },
        
        {
          
          "@type": "ListItem",
          "position": 2,
          "name": "",
          "item": "https://denisidoro.github.io/blog/"
        },
        
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Using Grafana for personal financial management",
          "item": "https://denisidoro.github.io/blog/grafana-personal-finance/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;d8f0e5c553a5794d00.jpg" alt="profile picture">
        </a>
        <nav>
          
            <a href="&#x2F;tags&#x2F;">Tags</a>
          
            <a href="&#x2F;blog&#x2F;">Blog</a>
          
        </nav>
      </header>
    
    <main>
    
<div class="post-title">
  <h1>Using Grafana for personal financial management</h1>
  <small>
    April 04, 2019
    
    -
    <span class="tags">
      
      <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;grafana&#x2F;">grafana</a>
      
      <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;finance&#x2F;">finance</a>
      
      <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;clojure&#x2F;">clojure</a>
      
    </span>
    
  </small>
</div>

<div>
  <figure>
    <img alt="Image for post" class="medium-image"
        src="https://miro.medium.com/max/2160/1*tfGEp0dvIJ1_L3-D0rJSdw.jpeg"
        srcSet="https://miro.medium.com/max/552/1*tfGEp0dvIJ1_L3-D0rJSdw.jpeg 276w, https://miro.medium.com/max/1104/1*tfGEp0dvIJ1_L3-D0rJSdw.jpeg 552w, https://miro.medium.com/max/1280/1*tfGEp0dvIJ1_L3-D0rJSdw.jpeg 640w, https://miro.medium.com/max/1400/1*tfGEp0dvIJ1_L3-D0rJSdw.jpeg 700w"
        sizes="700px" />
    <figcaption>One of the dashboards provided by the system</figcaption>
</figure>
<p>This post is intended to be a brain dump with quick highlights of some technologies. If you’re somewhat familiar with the stack I’ve used, hopefully there will be something useful for you to learn or to base on. It will be fast paced.</p>
<h3 id="objective">Objective</h3>
<p>To develop an investment tracker with the following requirements:</p>
<ul>
<li>everything must be determined by a plain-text file;</li>
<li>the only recurring input needed is sparse balance data;</li>
<li>it must infer data as good as possible;</li>
<li>it must maintain historic data;</li>
<li>it must draw beautiful visualizations.</li>
</ul>
<p>In other words, if I write down today the balance of some investments of mine, and 1 month from now I write down the balance of other investments, the system should be able to interpolate data so that it can plot smooth, realistic curves.</p>
<p>This is different from a ledger system, for which there are plenty of open source solutions.</p>
<p>It could be done with some Excel wizardry, I suppose. But I didn’t want to learn that much of Excel.</p>
<h3 id="file-syntax">File syntax</h3>
<p>I’ve decided to use the <a href="https://github.com/edn-format/edn">edn format</a>, because I was determined to code the system in <a href="https://clojure.org/">Clojure</a>. Here is some simplified, mock data:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;d9c38c04feb8e69c27d706adf435043a.js"></script>
</div>
<p>It has as little information as possible yet it still is human-readable. Nice!</p>
<h3 id="internalizing-data">Internalizing data</h3>
<p>The first step was to convert the file contents to internal models with namespaced keys. In particular, I converted date strings to a numeric format so that I could apply traditional math over it. After some maps and reduces, we have a collection of elements such as:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;8ffe9d8009d712a500ba1fbe79c8e93c.js"></script>
</div>
<p>Initially, I had written functions for integrals, derivatives, curve aggregation and so on. But I was reinventing the wheel. Now, I’m leveraging the robustness of time-series ecosystems.</p>
<p>The competitors were <a href="https://prometheus.io/">Prometheus</a>, <a href="https://www.influxdata.com/">InfluxDB</a> and <a href="https://graphiteapp.org/">Graphite</a>. As of the time of writing, there’s no way to fetch past data into Prometheus. InfluxDB has too much SQL for my taste. Graphite was the chosen one, then.</p>
<p>With a simple pure function, we can export our internal models as Graphite-compatible data:</p>
<pre style="background-color:#f9f9f9;">
<code><span style="color:#111111;">citigroup.rf.cdb_paribas 1554325794 1000.00
citigroup.rf.cdb_paribas 1554378794 1050.33
citigroup.rf.cdb_paribas 1564325312 1097.44
</span></code></pre>
<p>Now we can perform queries such as <code>sumSeries(some.bucket.*)</code>, instead of hand crafting it directly in our code.</p>
<h3 id="visualizing-balances">Visualizing balances</h3>
<p>Graphite has a built-in renderer for data:</p>
<figure>
    <img alt="Image for post" class="medium-image"
        src="https://miro.medium.com/max/2160/1*nLHgAwVpSW9veGmMp_-Rbg.png"
        srcSet="https://miro.medium.com/max/552/1*nLHgAwVpSW9veGmMp_-Rbg.png 276w, https://miro.medium.com/max/1104/1*nLHgAwVpSW9veGmMp_-Rbg.png 552w, https://miro.medium.com/max/1280/1*nLHgAwVpSW9veGmMp_-Rbg.png 640w, https://miro.medium.com/max/1400/1*nLHgAwVpSW9veGmMp_-Rbg.png 700w"
        sizes="700px" />
    <figcaption>This is really ugly</figcaption>
</figure>
<p>But we aren’t in the 90s anymore. I wanted to use something easier on the eyes: <a href="https://grafana.com/">Grafana</a>.</p>
<p>Fortunately, Grafana works out of the box with Graphite, so it was a piece of cake to build beautiful dashboards:</p>
<figure>
    <img alt="Image for post" class="medium-image"
        src="https://miro.medium.com/max/2160/1*FFPJW-tIF3967y3BcEoSoQ.png"
        srcSet="https://miro.medium.com/max/552/1*FFPJW-tIF3967y3BcEoSoQ.png 276w, https://miro.medium.com/max/1104/1*FFPJW-tIF3967y3BcEoSoQ.png 552w, https://miro.medium.com/max/1280/1*FFPJW-tIF3967y3BcEoSoQ.png 640w, https://miro.medium.com/max/1400/1*FFPJW-tIF3967y3BcEoSoQ.png 700w"
        sizes="700px" />
    <figcaption>The main dashboard</figcaption>
</figure>
<h3 id="tabular-and-scalar-data">Tabular and scalar data</h3>
<p>Even though piping data to Graphite made my life easier, it limited possibilities. There’s no simple way to display in a table all the info for yielding investments. Or adding a single stat with the next investment maturity date.</p>
<p>It became clear I had to add a second data source. Considering that some steps before I already had all the data in Clojure code, I decided to upgrade the Clojure scripts to an HTTP server.</p>
<figure>
    <img alt="Image for post" class="medium-image"
        src="https://miro.medium.com/max/2160/1*274rN8NGm-TdaKmZXEwquA.png"
        srcSet="https://miro.medium.com/max/552/1*274rN8NGm-TdaKmZXEwquA.png 276w, https://miro.medium.com/max/1104/1*274rN8NGm-TdaKmZXEwquA.png 552w, https://miro.medium.com/max/1280/1*274rN8NGm-TdaKmZXEwquA.png 640w, https://miro.medium.com/max/1400/1*274rN8NGm-TdaKmZXEwquA.png 700w"
        sizes="700px" />
    <figcaption>InfluxDB can’t provide this tabular data</figcaption>
</figure>
<p>Grafana has support for <a href="https://grafana.com/plugins/grafana-simple-json-datasource">JSON APIs as data source</a>. Its serialization format is different from Graphite’s but I only had to write yet another pure, adapter function to get a result like this:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;f2cb104d0c47aec5e93b81d84568ef67.js"></script>
</div>
<h3 id="extras">Extras</h3>
<p>After finishing all the groundwork, it became easy peasy to add new features, such as consuming external APIs for displaying stock values or currency history, to name a few.</p>
<figure>
    <img alt="Image for post" class="medium-image"
        src="https://miro.medium.com/max/2160/1*7TJ_w-ThefC6aVi4Yy4J9g.png"
        srcSet="https://miro.medium.com/max/552/1*7TJ_w-ThefC6aVi4Yy4J9g.png 276w, https://miro.medium.com/max/1104/1*7TJ_w-ThefC6aVi4Yy4J9g.png 552w, https://miro.medium.com/max/1280/1*7TJ_w-ThefC6aVi4Yy4J9g.png 640w, https://miro.medium.com/max/1400/1*7TJ_w-ThefC6aVi4Yy4J9g.png 700w"
        sizes="700px" />
    <figcaption>Currencies and stock information scraped from third-party APIs</figcaption>
</figure>
<p><a href="https://github.com/denisidoro/rosebud/blob/e68671b/server/resources/example_log.edn">This</a> is a complete edn file specifying what currencies and stocks we should keep track of.</p>
<h3 id="deploying">Deploying</h3>
<p>The easiest way to install Grafana on OSX is to use <a href="https://brew.sh/">brew</a>. Then you run <code>brew service start</code> and have to remember to stop it because the service persists even after a reboot. Then there's Graphite and Clojure.</p>
<p>Maybe there’s a better way to do it but I rage quit it and started using <a href="https://www.docker.com/">docker</a> for everything instead.</p>
<p>By mounting volumes, we can start Grafana pre-configured with the default data sources and dashboards in a such way that we don’t have to set it up manually everytime.</p>
<h3 id="adapting-it-to-your-needs">Adapting it to your needs</h3>
<p><a href="https://github.com/denisidoro/rosebud">The code is available on Github</a> for you to fork. It’s a little bit oriented to my needs and the Brazilian financial system. However, smalls adjustments should be enough to adapt it.</p>
<h3 id="conclusion">Conclusion</h3>
<p>I’m very happy with the result because I was able to develop it quickly, without having to learn new tools. <a href="https://medium.com/@den.isidoro/microservice-size-and-splitting-dd9fc98a262e">The way the namespaces and models are organized</a> facilitates swapping backends or splitting the code into microservices, if the future demands it.</p>
<figcaption>⏮ This post first appeared on
    <a href="https://medium.com/@den.isidoro/using-grafana-for-personal-financial-management-ac0e4d0cb43" target="_blank">Medium</a></figcaption>

</div>

<hr class="footer-rule" />


<div class="footer-about">
  <p><em>Note: opinions expressed here are solely my own and do not necessarily express the views or experiences of my employer or past employers.</em></p>

</div>


<div class="related-container">

  
  <div class="link">
    Previous <br />
    <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;microservice-splitting-code-refactoring&#x2F;">On microservice splitting and code refactoring</a>
  </div>
  

  
  <div class="link">
    Next <br />
    <a href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;blog&#x2F;monolithic-apps-graph-apis&#x2F;">Writing multi-module, monolithic apps with graph APIs</a>
  </div>
  

</div>


    </main>
  </body>
</html>
