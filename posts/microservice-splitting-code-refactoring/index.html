<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
    <link rel="icon" href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;bb8e06f1bd83412a00.jpg" />
    <link rel="apple-touch-icon" sizes="48x48"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;bb8e06f1bd83412a00.jpg" />
    <link rel="apple-touch-icon" sizes="72x72"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;919926a10d297a1500.jpg" />
    <link rel="apple-touch-icon" sizes="96x96"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;6c2aa64354c1ad0e00.jpg" />
    <link rel="apple-touch-icon" sizes="144x144"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;f15f82763548a03000.jpg" />
    <link rel="apple-touch-icon" sizes="192x192"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;60ba6917360f159900.jpg" />
    <link rel="apple-touch-icon" sizes="256x256"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;be09d2da8b7096cc00.jpg" />
    <link rel="apple-touch-icon" sizes="384x384"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;165598e81aa1737500.jpg" />
    <link rel="apple-touch-icon" sizes="512x512"
      href="https:&#x2F;&#x2F;denisidoro.github.io&#x2F;processed_images&#x2F;ca26ad195d4a364c00.jpg" />
  

  
  
  
  
  
  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css" rel="stylesheet" />
  <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/twelve/galleria.twelve.min.css"
    rel="stylesheet" /> 
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" /> -->
  <link href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;site.css' rel="stylesheet" /> 
  <title>
    
  Denis Isidoro | On microservice splitting and code refactoring

  </title>
  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-168912661-1"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "UA-168912661-1");
  </script>
  
</head>

<body class="has-background-light">
  
  <nav aria-label="main navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">Denis Isidoro</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags'>
            Tags
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  
  <div class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </div>
  
  
  <main class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-10 is-offset-1">
          <article>
            <h1 class="title">On microservice splitting and code refactoring</h1>
            <h2 class="subtitle"></h2>
            <div class="columns mb-0">
              <div class="column">
                
<p class="has-text-grey">
  <!-- CUSTOM 
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  Denis Isidoro published on 
  -->
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <time datetime='2019-01-06'>January 06, 2019</time>
</p>

              </div>
              <div class="column has-text-right-desktop">
                
<p class="has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  6 min,
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  1075 words
</p>

              </div>
              <div class="column has-text-right-desktop">
                
                  
<p>
  <span class="has-text-black has-text-weight-normal">Tags:</span>
  
  <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;dev&#x2F;'>
    <span class="icon is-small">
      <i class="fas fa-tag fa-xs"></i>
    </span>
    dev
  </a>
  
  <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;tags&#x2F;architecture&#x2F;'>
    <span class="icon is-small">
      <i class="fas fa-tag fa-xs"></i>
    </span>
    architecture
  </a>
  
</p>

                
              </div>
            </div>
            <!-- CUSTOM 
            <div class="columns mb-0">
              <div class="column">
                
              </div>
            </div>
            -->
            
            <hr/>
            <div class="content has-text-justified">
              <figure class="medium-cover">
    <img alt="Image for post" class="t u v gh aj" src="https://miro.medium.com/max/11014/0*YzywaYKyaA6w-HcY" srcSet=" https://miro.medium.com/max/552/0*YzywaYKyaA6w-HcY 276w, https://miro.medium.com/max/1104/0*YzywaYKyaA6w-HcY 552w,
    https://miro.medium.com/max/1280/0*YzywaYKyaA6w-HcY 640w, https://miro.medium.com/max/1400/0*YzywaYKyaA6w-HcY 700w" sizes="700px" />
    <figcaption>Photo by
        <a href="https://unsplash.com/@leliejens?utm_source=medium&utm_medium=referral">leliejens</a>
        on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a> </figcaption>
</figure>
<p>Let’s say that you work for a company that offers a platform for personal finance management. You were requested to add a feature whose input from the customer is a list of company × amount of stocks × investment date and the output is the customer’s total balance for a given point in time.</p>
<p>How big or small should the microservice(s) be?</p>
<p>At one end of the spectrum, you have a single <a href="https://www.thoughtworks.com/insights/blog/monoliths-are-bad-design-and-you-know-it">monolith</a>, with scalability issues.</p>
<p>At the other end, you have one service for:</p>
<ul>
<li>stock value scraping (<code>stockScraper</code>)</li>
<li>company info store (<code>companyStore</code>)</li>
<li>stock value history store (<code>stockHistory</code>)</li>
<li>customer input stock store (<code>stockStore</code>)</li>
</ul>
<p>This approach gives us a nice separation of concerns and makes it easy to develop and scale each part independently. However, it takes more time to have an <a href="https://en.wikipedia.org/wiki/Minimum_viable_product">MVP</a> this way, and <a href="https://en.wikipedia.org/wiki/Time_to_market">time to market</a> may be crucial. And it costs more, as well, because of overheads (such as multiple JVMs, databases, message streaming, etc).</p>
<p>Given your resource constraints, maybe it makes sense to start as a single service (<code>newFeature</code>). But what if you want or need to split it later?</p>
<p>Here are my tips for designing a service easy to refactor, at a low cost during development.</p>
<h3 id="0-divide-your-application-into-layers">0. Divide your application into layers</h3>
<p>You can choose from <a href="https://dzone.com/articles/onion-architecture-is-interesting">onion</a>, <a href="https://dzone.com/articles/layered-architecture-is-good">layered</a>, and <a href="https://dzone.com/articles/hexagonal-architecture-is-powerful">hexagonal</a> architectures, among others. As always, prioritize immutability, state management, pure logic extraction and all the other best practices.</p>
<h3 id="1-don-t-be-afraid-of-using-many-namespaces">1. Don’t be afraid of using many namespaces</h3>
<p>Don’t keep all namespaces (packages, files) centralized in a root one. Instead of <code>newFeature.logic.stockScraper</code>, use <code>stockScraper.logic</code>. Have you created a pure function that may be useful for both <code>stockScraper</code> and <code>stockStore</code>? Put it inside <code>stock.logic</code>. Have you written a function for linear interpolation? This math concept isn't restricted to a specific feature so it doesn't have to be inside <code>newFeature.logic.math</code>, for example. Put it inside <code>common.math</code>. This way you aren't tempted to put <code>linearInterpolate</code> and <code>stockSum</code> in the same file.</p>
<p>When the time comes for service splitting, you can deploy the <code>common</code> and <code>stock</code> folders as libraries and start the <code>stockScraper</code> service by cut and pasting the respective folder. Much easier than traversing all the codebase later to extract everything you need!</p>
<h3 id="2-import-non-common-namespaces-with-care">2. Import non-common namespaces with care</h3>
<p>Does <code>stockHistory</code> have to import <code>stockScraper</code> a lot? Can't it be minimized? Remember that when splitting this will translate into HTTP calls or message streaming. Try to at least isolate this dependency into a single namespace, which will be the precursor of the API between the two. This step is the most subjective, because it can quickly introduce overheads in the codebase for an MVP. You must consider the trade-offs.</p>
<h3 id="3-isolate-implementation-details-into-higher-level-components">3. Isolate implementation details into higher level components</h3>
<p>Let’s now implement the handler for the endpoint that returns information about all the companies a customer has stocks from. One common approach is the following (we’re exposing components via dependency injection and middlewares):</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;d77a550d25bd6a77d35b5b57d40cf4b8.js"></script>
</div>
<p>After splitting our service, not all data will be available via the <code>db</code> argument, of course. We'll need to make some HTTP calls. <code>customerCompaniesHandler</code> will have to get an HTTP component and pass it to <code>getCustomerCompanies</code>, which will propagate it to the domain-specific helper functions and so on...</p>
<p>But why does the handler have to know this in the first place? We have divided our application into layers and, more importantly, we have already separated our code into <code>companyStore</code>, <code>stockStore</code> and other namespaces. Yet, we clearly have an implementation detail leak such that all our higher level, integration API code has to know about low level dependency management. These layers should be agnostic to where we store the <code>company</code> entity...</p>
<p>Ideally, our handler should only know that it has to fetch data that depends on the <code>stock</code> and <code>company</code> entities. What if we created a component that abstracts this away, per entity? Let's call one of them as <code>CompanyRepository</code> (you can come up with the name you like):</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;335efcab949ddaa3f40c78a9fec4666e.js"></script>
</div>
<p>You can skip the interface/protocol definition if you’re not into that. The important thing is to avoid leaking lower level components.</p>
<p>After adding this component to our dependency graph, our code would become:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;36dd706464e5cbb223fd6debdfba24a9.js"></script>
</div>
<p>For the service split, we could create:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;denisidoro&#x2F;36dd706464e5cbb223fd6debdfba24a9.js"></script>
</div>
<p>The only thing we need to do is update the dependency graph! All the rest of the code remains the same.</p>
<p>As a plus, we can move <code>CompanyDbRepository</code> to <code>companyStore</code>. Code reuse!</p>
<h3 id="wrap-up">Wrap up</h3>
<p>Suppose you’re absolutely certain that you won’t have to split your recently created microservice or that the process will be easy enough such that you won’t curse your past self. Then, you may not see much value in my article.</p>
<p>However, this isn’t just about spatial organization or isolation. It’s about making domains arguably easier to reason about. Establishing higher level boundaries reduces the cognitive requirement to fiddle with a codebase. You only need to traverse the code as deep as required. I find it easier to handle new abstractions than reaching a mental stack overflow when browsing lines of code.</p>
<p>And even if you decide to keep a single service, it’s much easier for a newcomer to improve <code>stockParser</code>, for example, if he or she only has to read a root namespace and not the whole microservice code.</p>
<p>Anyway, no one is able to perfectly measure the ideal microservice size, because that varies in time, the company size, the feature success and many other factors. So it’s nice to be flexible.</p>
<h3 id="clojure-sidenotes">Clojure sidenotes</h3>
<ul>
<li><a href="https://github.com/duct-framework/duct">Duct</a> follows this pattern and calls it boundary.</li>
<li>You can skip the component creation altogether and define boundaries with resolvers using a library such as <a href="https://github.com/wilkerlucio/pathom">Pathom</a>: you define a graph edge that enables you to go from a <code>customerId</code> to a <code>company</code>, for example.</li>
</ul>
<h3 id="front-end-sidenote">Front-end sidenote</h3>
<p>Even though I focused on the back-end, this applies to front-end as well. Why make the <code>CompanyDetailsPage</code> receive an HTTP component and perform a request? It can simply receive a <code>CompanyRepository</code> and you can call <code>repository.getDetails()</code>.</p>
<div class="medium-first">
    This post first appeared on
    <a href="https://medium.com/@den.isidoro/microservice-size-and-splitting-dd9fc98a262e" target="_blank">Medium</a>.
</div>

            </div>
            <!-- CUSTOM <div id="mapid"></div> -->

            <div class="disclaimer">
              Note: opinions expressed here are solely my own and do not necessarily express the views or experiences of my employer or past employers.
            </div>
            
            <div class="container has-text-centered mt-6">
              
<!-- CUSTOM
<p class="is-size-5">
  Share:
  <a class="link" data-sharer="facebook" data-url='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;microservice-splitting-code-refactoring&#x2F;' href="javascript:void(0);"
    title="Share on facebook">
    <span class="icon">
      <i class="fab fa-facebook-square"></i>
    </span>
  </a>
  <a class="link" data-sharer="twitter" data-title='On microservice splitting and code refactoring' data-url='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;microservice-splitting-code-refactoring&#x2F;'
    href="javascript:void(0);" title="Share on twitter">
    <span class="icon">
      <i class="fab fa-twitter"></i>
    </span>
  </a>
  <a class="link" data-sharer="linkedin" data-url='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;microservice-splitting-code-refactoring&#x2F;' href="javascript:void(0);"
    title="Share on linkedin">
    <span class="icon">
      <i class="fab fa-linkedin"></i>
    </span>
  </a>
  <a class="link" data-sharer="reddit" data-url='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;microservice-splitting-code-refactoring&#x2F;' href="javascript:void(0);"
    title="Share on reddit">
    <span class="icon">
      <i class="fab fa-reddit"></i>
    </span>
  </a>
  <a class="link" data-sharer="hackernews" data-title="On microservice splitting and code refactoring" data-url='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;microservice-splitting-code-refactoring&#x2F;'
    href="javascript:void(0);" title="Share on hackernews">
    <span class="icon">
      <i class="fab fa-hacker-news"></i>
    </span>
  </a>
  <a class="link" data-sharer="whatsapp" data-title="On microservice splitting and code refactoring" data-url='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;microservice-splitting-code-refactoring&#x2F;'
    href="javascript:void(0);" title="Share on whatsapp">
    <span class="icon">
      <i class="fab fa-whatsapp-square"></i>
    </span>
  </a>
</p>
-->

            </div>
          </article>
          <hr/>
          
            <nav class="level mt-2">
              
                <div class="level-item has-text-centered">
                  <a class="button is-black is-outlined" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;grafana-personal-finance&#x2F;'>
                    <span class="icon mr-2">
                      <i class="fas fa-arrow-circle-left"></i>
                    </span>
                    Using Grafana for personal financial management
                  </a>
                </div>
              
              
                <div class="level-item has-text-centered">
                  <a class="button is-black is-outlined" href='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;posts&#x2F;moving-from-medium&#x2F;'>
                    Moving from Medium<span class="icon ml-2">
                      <i class="fas fa-arrow-circle-right"></i>
                    </span>
                  </a>
                </div>
              
              
              
            </nav>
          
          
        </div>
      </div>
    </div>
  </main>

  
  <!--<footer class="py-2">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola
    </p>
  </footer>-->
  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- 
    <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/twelve/galleria.twelve.min.js"></script>
  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;denisidoro.github.io&#x2F;js&#x2F;site.js'></script>
  
  

</body>

</html>